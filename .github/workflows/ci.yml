name: ğŸš€ Hahow Quality Engineer - CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2é»åŸ·è¡Œæ¸¬è©¦
    - cron: '0 2 * * *'

jobs:
  # API è‡ªå‹•åŒ–æ¸¬è©¦
  api-tests:
    name: ğŸ”Œ API è‡ªå‹•åŒ–æ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£ API æ¸¬è©¦ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ§ª åŸ·è¡Œ API æ¸¬è©¦
      run: |
        echo "é–‹å§‹åŸ·è¡Œ API è‡ªå‹•åŒ–æ¸¬è©¦..."
        python api_automation.py
        
    - name: ğŸ“ æº–å‚™å ±å‘Šç›®éŒ„ (API)
      run: |
        mkdir -p reports
        
    - name: ğŸ“Š åŸ·è¡Œ pytest API æ¸¬è©¦å¥—ä»¶
      run: |
        pytest api_automation.py -v --tb=short
        
    - name: ğŸ“„ ç”Ÿæˆ API æ¸¬è©¦å ±å‘Š
      run: |
        pytest api_automation.py --html=reports/api_report.html --self-contained-html
        
    - name: ğŸ“¤ ä¸Šå‚³ API æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: api-test-report
        path: reports/api_report.html

  # UI è‡ªå‹•åŒ–æ¸¬è©¦
  ui-tests:
    name: ğŸ–¥ï¸ UI è‡ªå‹•åŒ–æ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: ğŸŒ å®‰è£ Chrome ç€è¦½å™¨
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
        
    - name: ğŸ“¦ å®‰è£ UI æ¸¬è©¦ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r ui_requirements.txt
        
    - name: ğŸ“ æº–å‚™æ¸¬è©¦ç›®éŒ„ (UI)
      run: |
        mkdir -p reports screenshots logs
        
    - name: ğŸ”§ è¨­å®šæ¸¬è©¦ç’°å¢ƒ
      run: |
        python setup_environment.py
        
    - name: ğŸ§ª åŸ·è¡Œ UI æ¸¬è©¦
      env:
        CHROME_BIN: google-chrome
      run: |
        echo "é–‹å§‹åŸ·è¡Œ UI è‡ªå‹•åŒ–æ¸¬è©¦..."
        python ui_automation.py
        
    - name: ğŸ“Š åŸ·è¡Œ pytest UI æ¸¬è©¦å¥—ä»¶
      run: |
        pytest ui_automation.py -v --tb=short
        
    - name: ğŸ“„ ç”Ÿæˆ UI æ¸¬è©¦å ±å‘Š
      run: |
        pytest ui_automation.py --html=reports/ui_report.html --self-contained-html
        
    - name: ğŸ“¤ ä¸Šå‚³ UI æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ui-test-report
        path: reports/ui_report.html
        
    - name: ğŸ“¸ ä¸Šå‚³æ¸¬è©¦æˆªåœ–
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ui-screenshots
        path: screenshots/

  # æ•´åˆæ¸¬è©¦
  integration-tests:
    name: ğŸ”— æ•´åˆæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: [api-tests, ui-tests]
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£æ‰€æœ‰ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r ui_requirements.txt
        
    - name: ğŸŒ å®‰è£ Chrome ç€è¦½å™¨
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
        
    - name: ğŸ“ æº–å‚™æ¸¬è©¦ç›®éŒ„ (æ•´åˆ)
      run: |
        mkdir -p reports screenshots logs
        
    - name: ğŸ”§ è¨­å®šæ¸¬è©¦ç’°å¢ƒ
      run: |
        python setup_environment.py
        
    - name: ğŸš€ åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶
      run: |
        echo "é–‹å§‹åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶..."
        ./run_ui_tests.sh
        
    - name: ğŸ“Š ç”Ÿæˆæ•´åˆæ¸¬è©¦å ±å‘Š
      run: |
        pytest api_automation.py ui_automation.py --html=reports/integration_report.html --self-contained-html
        
    - name: ğŸ“¤ ä¸Šå‚³æ•´åˆæ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-report
        path: reports/integration_report.html

  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: ğŸ” ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£å“è³ªæª¢æŸ¥å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        pip install -r requirements.txt
        pip install -r ui_requirements.txt
        
    - name: ğŸ¨ æª¢æŸ¥ç¨‹å¼ç¢¼æ ¼å¼ (Black)
      run: |
        black --check --diff .
        
    - name: ğŸ“‹ æª¢æŸ¥ import æ’åº (isort)
      run: |
        isort --check-only --diff .
        
    - name: ğŸ” æª¢æŸ¥ç¨‹å¼ç¢¼é¢¨æ ¼ (Flake8)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: ğŸ·ï¸ é¡å‹æª¢æŸ¥ (MyPy)
      run: |
        mypy . --ignore-missing-imports

  # æ¸¬è©¦è¦†è“‹ç‡
  coverage:
    name: ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r ui_requirements.txt
        pip install coverage pytest-cov
        
    - name: ğŸ“Š åŸ·è¡Œè¦†è“‹ç‡æ¸¬è©¦
      run: |
        pytest api_automation.py ui_automation.py --cov=. --cov-report=xml --cov-report=html
        
    - name: ğŸ“¤ ä¸Šå‚³è¦†è“‹ç‡å ±å‘Š
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        
    - name: ğŸ“¤ ä¸Šå‚³è¦†è“‹ç‡ HTML å ±å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: htmlcov/

  # éƒ¨ç½²æ¸¬è©¦å ±å‘Š
  deploy-reports:
    name: ğŸš€ éƒ¨ç½²æ¸¬è©¦å ±å‘Š
    runs-on: ubuntu-latest
    needs: [api-tests, ui-tests, integration-tests]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ ä¸‹è¼‰æ‰€æœ‰æ¸¬è©¦å ±å‘Š
      uses: actions/download-artifact@v3
      with:
        path: reports/
        
    - name: ğŸŒ éƒ¨ç½²åˆ° GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./reports
        destination_dir: reports
